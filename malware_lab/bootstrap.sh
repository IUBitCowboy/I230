#!/usr/bin/env bash

# Initial bootstrap.sh for I230_malwware_lab
# This script will run as root

# The following variables contain the URL of the malware packages. 
VOLCANO_URL=https://github.com/IUBitCowboy/I230/raw/master/malware_lab/volcano.tgz
DR_EVIL_URL=https://github.com/IUBitCowboy/I230/raw/master/malware_lab/dr_evil.tgz

VOLCANO_TAR=volcano.tgz
DR_EVIL_TAR=drevil.tgz

# This installs Scott Evil's malware package.
function install_volcano_lair {
	VOL_DIR=/etc/.volcano_lair
	# fetch and install the volcano lair
	wget $VOLCANO_URL -O $VOLCANO_TAR 
	tar -C /etc -xzf /tmp/$VOLCANO_TAR
	mv /etc/volcano $VOL_DIR
	
	chown -R root:evil $VOL_DIR
	
	# add entry to cronjob to get it to run
	echo "*/2 * * * * root $VOL_DIR/scott_evil.sh" >> /etc/crontab
	touch $VOL_DIR
	
}

# This installs Dr Evil's malware package.
function install_DrEvil {
	EVIL_DIR=/usr/local/games/dr_evil
	
	
	# install the python-daemon used by Dr Evil
	apt-get -q -y install python3-daemon
	
	# fetch the drevile tar file 
	wget $DR_EVIL_URL -O $DR_EVIL_TAR 
	tar -C /usr/local/games -xzf /tmp/$DR_EVIL_TAR
	
	# Create account for Dr Evil
	addgroup --quiet evil
	addgroup --quiet vagrant evil
	adduser --quiet --system --home $EVIL_DIR --ingroup evil --shell /bin/bash drevil
	addgroup --quiet drevil admin
	
	# chown of the files 
	chown -R drevil:evil $EVIL_DIR
	
	# link for data exfiltration
	touch $EVIL_DIR/evil.log
	ln -s $EVIL_DIR/evil.log /var/www
	chgrp www-data $EVIL_DIR/evil.log
	chmod +r $EVIL_DIR/evil.log
	
	# install the init script for the daemon
	cp $EVIL_DIR/evil.init /etc/init.d/evil
	chmod +x /etc/init.d/evil
	chmod go-w /etc/init.d/evil
	chown root:evil /etc/init.d/evil
	
	# start the daemon
	# service evil start
	systemctl enable evil
	systemctl start evil
}


##############################################################
###               NOT RELATED TO MALWARE                   ###
##############################################################
function install_www {	
	# update the package cache
	apt-get -q -y update
	
	# install the apache for exfiltrating the data
	apt-get -q -y install apache2
	
	# setup the webserver to display alertl.log in the url
	addgroup --quiet www-data ossec
    addgroup --quiet www-data scanner
	ln -s /var/ossec/logs/alerts/alerts.log /var/www/html
	
}


##############################################################
###                  BEGIN MAIN                            ###
##############################################################
install_log="/tmp/bootstrap.log"

if [ ! -d /var/www ]; then
	printf "Updating system software...stage APACHE\n"
	install_www
fi

# BEGIN EVIL HERE

if [ ! -d /usr/local/games/dr_evil ]; then
	printf "Updating system software...stage DRE"
	install_DrEvil
fi

logrotate -f /etc/logrotate.conf

if [ ! -d /etc/.volcano_lair ]; then
	printf "Updating system software...stage VLE"
	install_volcano_lair
fi

# END EVIL

if ! grep -q alert /home/vagrant/.profile; then
	V_PROF=/home/vagrant/.profile
	echo "echo '********************************'" >> $V_PROF
	echo "echo " >> $V_PROF
	echo "echo 'Be sure to check /etc, /tmp, and /var/log for recently changed files.'" >> $V_PROF
	echo "echo 'Many log files are restricted to root. How will you view those files?' " >> $V_PROF
	echo "echo 'Use grep to look for evil. '" >> $V_PROF
	echo "echo 'Remember the -A option for ls command. '" >> $V_PROF
	echo "echo '********************************'" >> $V_PROF
	echo "echo " >> $V_PROF
	
fi

# restart apache to make sure it pickup up the alerts.log
service apache2 restart

# Verify we can actually work
touch /tmp/BOOTSTRAP_SUCCESS


